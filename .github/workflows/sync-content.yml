name: Sync Content to Database

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all content (even if unchanged)'
        required: false
        type: boolean
        default: false

jobs:
  sync-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Install wrangler
        run: npm install -g wrangler
      
      - name: Ensure database schema is up to date
        run: |
          echo "🗄️ Ensuring content_items table exists..."
          # Create table if it doesn't exist (idempotent)
          wrangler d1 execute baba-is-win-db --file migrations/0006_add_content_tracking.sql || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      
      - name: Sync content to database
        run: |
          echo "🔍 Scanning filesystem for content..."
          
          # Get existing content from database
          echo "📊 Getting existing content from database..."
          existing_content=$(wrangler d1 execute baba-is-win-db --command "SELECT slug, content_type FROM content_items;" --json)
          echo "Existing content: $existing_content"
          echo "Existing content structure:"
          echo "$existing_content" | jq .
          
          # Scan for blog posts
          echo "📝 Scanning for blog posts..."
          for blog_file in src/data/blog-posts/published/*.md; do
            if [ -f "$blog_file" ]; then
              slug=$(basename "$blog_file" .md)
              echo "Found blog post: $slug"
              
              # Check if already in database (handle different possible response formats)
              if ! echo "$existing_content" | jq -e "(.results // .)[] | select(.slug == \"$slug\" and (.content_type // .content_type) == \"blog\")" > /dev/null 2>&1; then
                echo "➕ Adding new blog post: $slug"
                
                # Extract metadata from file and escape single quotes
                title=$(grep "^title:" "$blog_file" | sed 's/title: *//' | sed 's/^"//' | sed 's/"$//' | sed "s/'/''/g")
                description=$(grep "^description:" "$blog_file" | sed 's/description: *//' | sed 's/^"//' | sed 's/"$//' | sed "s/'/''/g")
                publish_date=$(grep "^publishDate:" "$blog_file" | sed 's/publishDate: *//')
                
                # Convert date to Unix timestamp
                publish_timestamp=$(date -d "$publish_date" +%s 2>/dev/null || date -j -f "%d %b %Y" "$publish_date" +%s 2>/dev/null || echo "0")
                
                # Insert into database with properly escaped values
                wrangler d1 execute baba-is-win-db --command "
                  INSERT INTO content_items (slug, content_type, title, description, publish_date, file_path, notification_sent, created_at)
                  VALUES ('$slug', 'blog', '$title', '$description', $publish_timestamp, '$blog_file', 0, datetime('now'));
                "
              else
                echo "✅ Blog post already exists: $slug"
              fi
            fi
          done
          
          # Scan for thoughts
          echo "💭 Scanning for thoughts..."
          for thought_file in src/data/thoughts/published/*.md; do
            if [ -f "$thought_file" ]; then
              slug=$(basename "$thought_file" .md)
              echo "Found thought: $slug"
              
              # Check if already in database (handle different possible response formats)
              if ! echo "$existing_content" | jq -e "(.results // .)[] | select(.slug == \"$slug\" and (.content_type // .content_type) == \"thought\")" > /dev/null 2>&1; then
                echo "➕ Adding new thought: $slug"
                
                # Extract metadata from file and escape single quotes
                title=$(grep "^title:" "$thought_file" | sed 's/title: *//' | sed 's/^"//' | sed 's/"$//' | sed "s/'/''/g")
                publish_date=$(grep "^publishDate:" "$thought_file" | sed 's/publishDate: *//')
                
                # Convert date to Unix timestamp
                publish_timestamp=$(date -d "$publish_date" +%s 2>/dev/null || date -j -f "%d %b %Y" "$publish_date" +%s 2>/dev/null || echo "0")
                
                # Insert into database with properly escaped values
                wrangler d1 execute baba-is-win-db --command "
                  INSERT INTO content_items (slug, content_type, title, publish_date, file_path, notification_sent, created_at)
                  VALUES ('$slug', 'thought', '$title', $publish_timestamp, '$thought_file', 0, datetime('now'));
                "
              else
                echo "✅ Thought already exists: $slug"
              fi
            fi
          done
          
          echo "✅ Content sync completed successfully"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      
      - name: Check content status after sync
        run: |
          echo ""
          echo "Checking content and notification status after sync..."
          
          curl -X GET https://personal.emily-cogsdill.workers.dev/api/admin/check-notifications \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            | jq '{
              summary,
              unnotifiedContent: .unnotifiedContent | map({slug, type, title, isNotified}),
              totalUnnotified: .unnotifiedContent | length
            }'
      
      - name: Show sync summary
        run: |
          echo ""
          echo "=== SYNC SUMMARY ==="
          echo "1. Content has been synced from markdown files to database"
          echo "2. Check the unnotifiedContent above to see what needs notification"
          echo "3. To send notifications, use the 'Process Email Notifications' workflow"
          echo "4. To force re-notification of content, use the 'Reset Notifications' workflow first"
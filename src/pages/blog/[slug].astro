---
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import FooterBio from '../../components/FooterBio.astro';
import PremiumContent from '../../components/PremiumContent.astro';
import { getBlogPostBySlug } from '../../lib/db/content';

const { slug } = Astro.params;

// Get D1 database from runtime environment
const db = Astro.locals.runtime.env.DB;

// Get current user for premium content handling
const user = Astro.locals?.user || null;
const isAuthenticated = !!user;
const isAdmin = user?.isAdmin === true;

// Fetch the blog post from D1
const post = await getBlogPostBySlug(db, slug);

if (!post) {
  return Astro.redirect('/404');
}

// Only allow admins to view draft posts
const isDraft = post.status === 'draft';
if (isDraft && !isAdmin) {
  return Astro.redirect('/404');
}

const { title, description, publishDate, premium, content, readingTimeMinutes } = post;
const permalink = `${Astro.site.href}blog/${slug}`;

// Format reading time
const readingTime = readingTimeMinutes ? `${readingTimeMinutes} min read` : '';

const isPremium = premium === true;

// Create frontmatter-like object for PremiumContent component
const frontmatter = {
  premium: isPremium,
  publishDate: publishDate || '',
};
---

<BaseLayout title={title} description={description} permalink={permalink} current="blog">
  {isDraft && <div class="draft-banner">DRAFT - Only visible to admins</div>}
  <header class={isDraft ? 'draft' : ''}>
    <p>{publishDate || 'No date'} ~ {readingTime}</p>
    <h1>{title || 'Untitled'}</h1>
    <hr />
  </header>
  <div class="container">
    <article class="content">
      <PremiumContent
        content={content}
        isPremium={isPremium}
        isAuthenticated={isAuthenticated}
        contentType="blog"
        frontmatter={frontmatter}
        showIndicator={false}
      />
    </article>
    <hr />
    <div class="back-to-blog">
      <a href="/blog">‚Üê Back to Blog</a>
    </div>
    <FooterBio />
  </div>
</BaseLayout>

<style>
  .draft-banner {
    background: #f59e0b;
    color: #000;
    text-align: center;
    padding: 0.5rem;
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  header {
    text-align: center;
  }

  header.draft {
    border: 2px dashed #f59e0b;
    border-radius: 8px;
    padding: 1rem;
  }

  header h1 {
    margin-bottom: 0.7em;
  }

  header p {
    color: var(--text-secondary);
    text-transform: uppercase;
    font-family: var(--font-family-sans);
    font-weight: 600;
  }

  header hr {
    min-width: 100px;
    width: 30%;
  }

  .back-to-blog {
    text-align: center;
    margin: 2em 0;
  }

  .back-to-blog a {
    color: var(--text-secondary);
    text-decoration: none;
    font-family: var(--font-family-sans);
    font-weight: 600;
  }

  .back-to-blog a:hover {
    text-decoration: underline;
  }
</style>
